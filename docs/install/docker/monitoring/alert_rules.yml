# HuLa-Server 告警规则配置

groups:
  - name: hula-server-alerts
    rules:
      # 服务不可用告警
      - alert: ServiceDown
        expr: up == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "服务 {{ $labels.job }} 不可用"
          description: "服务 {{ $labels.instance }} 已经不可用超过1分钟"

      # 高CPU使用率告警
      - alert: HighCpuUsage
        expr: process_cpu_usage > 0.8
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "服务 {{ $labels.job }} CPU使用率过高"
          description: "服务 {{ $labels.instance }} CPU使用率超过80%持续5分钟"

      # 高内存使用率告警
      - alert: HighMemoryUsage
        expr: jvm_memory_used_bytes{area="heap"} / jvm_memory_max_bytes{area="heap"} > 0.85
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "服务 {{ $labels.job }} 内存使用率过高"
          description: "服务 {{ $labels.instance }} 堆内存使用率超过85%持续5分钟"

      # HTTP请求错误率告警
      - alert: HighHttpErrorRate
        expr: sum(rate(http_server_requests_seconds_count{status=~"5.."}[5m])) / sum(rate(http_server_requests_seconds_count[5m])) > 0.05
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "HTTP 5xx 错误率过高"
          description: "HTTP 5xx 错误率超过5%持续5分钟"

      # 响应时间过长告警
      - alert: HighResponseTime
        expr: histogram_quantile(0.95, sum(rate(http_server_requests_seconds_bucket[5m])) by (le)) > 2
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "API响应时间过长"
          description: "95%的请求响应时间超过2秒持续5分钟"

  - name: infrastructure-alerts
    rules:
      # MySQL连接数告警
      - alert: MysqlTooManyConnections
        expr: mysql_global_status_threads_connected > 400
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "MySQL连接数过多"
          description: "MySQL连接数超过400持续5分钟"

      # Redis内存告警
      - alert: RedisHighMemory
        expr: redis_memory_used_bytes / redis_memory_max_bytes > 0.9
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Redis内存使用率过高"
          description: "Redis内存使用率超过90%持续5分钟"

      # 磁盘空间告警
      - alert: DiskSpaceLow
        expr: (node_filesystem_avail_bytes{mountpoint="/"} / node_filesystem_size_bytes{mountpoint="/"}) < 0.1
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "磁盘空间不足"
          description: "根分区可用空间低于10%"

  - name: e2ee-alerts
    rules:
      # E2EE加密延迟告警
      - alert: E2EEHighEncryptionLatency
        expr: histogram_quantile(0.95, sum(rate(e2ee_encryption_duration_seconds_bucket[5m])) by (le)) > 0.5
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "E2EE加密延迟过高"
          description: "95%的E2EE加密操作延迟超过500ms持续5分钟"

      # E2EE错误率告警
      - alert: E2EEHighErrorRate
        expr: sum(rate(e2ee_errors_total[5m])) / sum(rate(e2ee_operations_total[5m])) > 0.01
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "E2EE错误率过高"
          description: "E2EE操作错误率超过1%持续5分钟"
