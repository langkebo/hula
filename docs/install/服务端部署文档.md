# HuLa-Server æœåŠ¡ç«¯éƒ¨ç½²æ–‡æ¡£

**ç‰ˆæœ¬**: 3.0.6
**æ›´æ–°æ—¥æœŸ**: 2025-12-16
**Javaç‰ˆæœ¬**: JDK 21

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

| æ–‡æ¡£ | è¯´æ˜ |
|------|------|
| [å¿«é€Ÿå¼€å§‹æŒ‡å—](QUICK_START.md) | 5åˆ†é’Ÿå¿«é€Ÿå¯åŠ¨å¼€å‘ç¯å¢ƒ |
| [Ubuntuéƒ¨ç½²æŒ‡å—](../HuLa-Server-Ubuntuéƒ¨ç½²æŒ‡å—.md) | è¯¦ç»†çš„Ubuntuç”Ÿäº§éƒ¨ç½²æŒ‡å— |
| [ç”Ÿäº§éƒ¨ç½²è¯„ä¼°](../PRODUCTION_DEPLOYMENT_ASSESSMENT.md) | ç”Ÿäº§ç¯å¢ƒå°±ç»ªåº¦è¯„ä¼°æŠ¥å‘Š |

---

## ğŸš€ ä¸€é”®éƒ¨ç½² (æ¨è)

```bash
# å°† docs/install/ ä¸Šä¼ åˆ°æœåŠ¡å™¨å¹¶æ”¾åˆ° /home/docker/install

# è¿›å…¥dockerç›®å½•
cd /home/docker/install/docker

# ç”Ÿäº§ç¯å¢ƒå…ˆåˆå§‹åŒ–å¯†ç ï¼ˆä¼šç”Ÿæˆ .env å¹¶å†™å…¥å…³é”®å˜é‡ï¼‰
bash init-passwords.sh

# å¦‚æœ Docker Hub è®¿é—®å—é™ï¼Œå¯å…ˆé…ç½®é•œåƒåŠ é€Ÿå™¨ï¼›ä¹Ÿå¯åœ¨ .env è®¾ç½® SRS_IMAGE æŒ‡å‘å¯è®¿é—®é•œåƒ

# ä¿®æ”¹RocketMQé…ç½® (å¿…é¡»!)
vim rocketmq/broker/conf/broker.conf
# å°† brokerIP1 æ”¹ä¸ºä½ çš„æœåŠ¡å™¨IPï¼ˆä¾‹å¦‚ 10.168.3.50ï¼‰

# æ‰§è¡Œéƒ¨ç½²è„šæœ¬
bash deploy.sh

# æˆ–è€…ç”Ÿäº§ç¯å¢ƒ
bash deploy.sh prod
```

---

## ğŸ“ æ‰‹åŠ¨éƒ¨ç½²æ­¥éª¤

### ä¿®æ”¹ç¯å¢ƒé…ç½®

ä¸Šä¼ ç›®å½•ä¸‹çš„dockeræ–‡ä»¶å¤¹åˆ°æœåŠ¡å™¨ `/home/docker/install` ä¸‹é¢, éœ€è¦ä¿®æ”¹ env æ–‡ä»¶å¤¹ã€rocketmq æ–‡ä»¶å¤¹é‡Œé¢çš„é…ç½®, ç‰¹åˆ«æ˜¯ [broker.conf](docker/rocketmq/broker/conf/broker.conf) é‡Œé¢ brokerIP1 çš„å€¼

## ğŸ› ï¸ æ³¨å†Œæ—¶éœ€è¦çš„é‚®ç®±åŠŸèƒ½
- **é…ç½®é‚®ç®±å¯†é’¥**: ![login.png](image/login.png)

## ğŸ› ï¸ å¯åŠ¨å‘½ä»¤
- **æé«˜æƒé™**: sudo chmod -R 777 /home/docker/install/docker/rocketmq
- **å¼€æ”¾ç«¯å£**: å…ˆå»ä½ è´­ç‰©æœåŠ¡å™¨çš„å¹³å°é‡Œé¢çš„å®‰å…¨ç»„é‡Œé¢æ”¾è¡Œmysqlã€redisã€rocketmqéƒ¨ç½²çš„ç«¯å£ï¼Œå†å»1panelæˆ–å®å¡”ä¸‹é¢æ”¾è¡Œ
- **æ‰§è¡Œå‘½ä»¤**: cd /home/docker/install/docker && docker compose up -d
- **å¯¼å…¥mysqlæ•°æ®åº“**: `/home/docker/install/mysql-schema.sql` (nacos) ä»¥åŠ `/home/docker/install/sql/luohuo_dev.sql`ã€`/home/docker/install/sql/luohuo_im_01.sql` (ä¸šåŠ¡åº“)
- **é‡è¯•nacos**: å¦‚æœè¿˜ä¸è¡Œå°±åˆ äº†nacosçš„å®¹å™¨ï¼Œé‡æ–°æ‰§è¡Œ docker compose up -d

---

## ğŸ—„ï¸ æ•°æ®åº“åˆå§‹åŒ–ä¸è¿ç§»

### åˆå§‹åŒ–ï¼ˆå¿…é¡»ï¼‰
- Nacos åº“ï¼š`docs/install/mysql-schema.sql`
- ä¸šåŠ¡åº“ï¼š`docs/install/sql/luohuo_dev.sql`ã€`docs/install/sql/luohuo_im_01.sql`

### PII åŠ å¯†è¿ç§»ï¼ˆå¯é€‰ï¼Œç”Ÿäº§å»ºè®®ï¼‰
- å­—æ®µæ‰©å®¹ï¼ˆè¿ç§»å‰æ‰§è¡Œï¼‰ï¼š`luohuo-cloud/install/sql/pii-field-expand.sql`
- è¿ç§»å‰éªŒè¯ï¼š`luohuo-cloud/install/sql/pii-migration-verify.sql`
- è¿ç§»åéªŒè¯ï¼š`luohuo-cloud/install/sql/pii-migration-post-verify.sql`

---

## ğŸ“ TURN æœåŠ¡ï¼ˆå¯é€‰ï¼‰

å¤æ‚ç½‘ç»œä¸‹è¯­éŸ³/è§†é¢‘å»ºè®®éƒ¨ç½² TURNï¼ˆcoturnï¼‰ï¼Œå‚è€ƒ `docs/install/docker/æ­å»ºturnæœåŠ¡.md`

## ğŸ–¼ï¸ æ•ˆæœé¢„è§ˆ
![ç¯å¢ƒéƒ¨ç½²æ•ˆæœ.png](image/%E7%8E%AF%E5%A2%83%E9%83%A8%E7%BD%B2%E6%95%88%E6%9E%9C.png)

## ğŸ› ï¸ å®‰è£…é¡¹ç›®ç¯å¢ƒ

- **å¼€æ”¾ç«¯å£**: å®‰å…¨ç»„é‡Œé¢æ”¾è¡Œjenkinséƒ¨ç½²çš„ç«¯å£ï¼Œå†å»1panelæˆ–å®å¡”ä¸‹é¢æ”¾è¡Œ, æˆ‘è¿™é‡Œé…ç½®çš„æ˜¯20000
- **å®‰è£…JDK21**: https://download.oracle.com/java/21/latest/jdk-21_linux-x64_bin.tar.gz [å®‰è£…åœ¨å®¿ä¸»æœº]
- **å®‰è£…gitã€maven**: æˆ‘æœºå™¨è‡ªå¸¦çš„gitã€https://maven.apache.org/download.cgi ä¸‹è½½ç„¶åä¸Šä¼ è§£å‹å³å¯ [å®‰è£…åœ¨å®¿ä¸»æœº]


## ğŸ› ï¸ jenkins ç¯å¢ƒé…ç½®
- **æŸ¥çœ‹å¯†ç **: docker logs -f jenkins | grep "initialAdminPassword"
![jenkinså¯†ç .png](image/jenkins%E5%AF%86%E7%A0%81.png)
- **è¿›å…¥jenkins**: http://ip:20000ï¼Œè¾“å…¥ä¸Šä¸€æ­¥æŸ¥çœ‹å¾—åˆ°çš„å¯†ç ï¼Œé…ç½®å„é¡¹åŸºç¡€ä¿¡æ¯
- **å®‰è£…æ’ä»¶**: è‡ªè¡Œé€‰æ‹©é»˜è®¤æ¨èçš„å°±è¡Œï¼Œantã€Gradleç­‰ä¸€äº›æ²¡ç”¨çš„æ’ä»¶å¯ä»¥å–æ¶ˆå‹¾é€‰
- **ä¸‹è½½å¿…é€‰jenkinsæ’ä»¶**: http://ip:20000/manage/pluginManager/
   ```
   Git Parameter
   Git plugin
   Maven Integration
   gitee
   Publish Over SSH
   ```
- **ç³»ç»Ÿå…¨å±€é…ç½®**: http://ip:20000/manage/configure é…ç½®ç¯å¢ƒå˜é‡
   ```
   PATH
   /opt/java/openjdk/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/var/jenkins_home/maven/bin:/root/bin
   ```
![img.png](image/img.png)
- **ç³»ç»Ÿå…¨å±€é…ç½®**: http://ip:20000/manage/configure é…ç½®é¡¹ç›®åœ°å€; æ·»åŠ å‡­è¯æ—¶å¿…é¡»é€‰giteeAPI, utilã€cloudä¸¤ä¸ªé¡¹ç›®åœ°å€éƒ½éœ€è¦é…è¿›å»,ç‚¹å‡»æµ‹è¯•é“¾æ¥æŒ‰é’®å¿…é¡»è¿”å›æˆåŠŸ
![img_2.png](image/img_2.png)
![img_1.png](image/img_1.png)

- **ç³»ç»Ÿå…¨å±€é…ç½®**: http://ip:20000/manage/configureTools/ é…ç½®jenkinså†…éƒ¨maven; é¡¹ç›®ç¯å¢ƒä¸­ä¸‹è½½çš„mavenè§£å‹åˆ° /home/jenkins/work ä¸‹é¢
![img_4.png](image/img_4.png)
![img_3.png](image/img_3.png)


## ğŸ› ï¸ åˆ›å»ºutilã€cloudé¡¹ç›®æµæ°´çº¿

- **åˆ›å»ºutil**: è¾“å…¥åç§°ã€é€‰æ‹©æµæ°´çº¿
![img_8.png](image/img_8.png)
- **é…ç½®util**: æ ¹æ®æ­¥éª¤ï¼Œä»”ç»†å¯¹æ¯”è¿™ä¸Šé¢çš„å†…å®¹
![img_6.png](image/img_6.png)
- **åˆ›å»ºè´¦å·å‡­è¯**: è¿™ä¸€æ­¥åˆ›å»ºçš„è´¦å·æ˜¯username!!!ï¼Œæ³¨æ„çœ‹æ˜¯ä½ ç™»å½•giteeçš„è´¦å·å¯†ç ã€‚ä¸æ˜¯apikey!
![img_5.png](image/img_5.png)

- **åˆ›å»ºcloud**: è¾“å…¥åç§°ã€é€‰æ‹©æµæ°´çº¿
![img_7.png](image/img_7.png)
- **é…ç½®cloud**: æ ¹æ®æ­¥éª¤ï¼Œä»”ç»†å¯¹æ¯”è¿™ä¸Šé¢çš„å†…å®¹
![img_9.png](image/img_9.png)

## ğŸ› ï¸ ç¼–è¯‘ utilã€cloud

- **install util**: å› ä¸ºcloudä¾èµ– util, æ‰€ä»¥å…ˆå®‰è£…utilåˆ°mavenæœ¬åœ°ä»“åº“
![img.png](image/img_11.png)

- **install cloud**: å¿…é¡»ç­‰utilæ¨¡å—installå®Œæˆæ‰è¡Œï¼Œè¿™æ ·cloudæ¨¡å—å°±å¯ä»¥é€šè¿‡mavenæœ¬åœ°ä»“åº“æ‰¾åˆ°utilä¾èµ–
![img_1.png](image/img_10.png)

## ğŸ› ï¸ è¿è¡Œé¡¹ç›®
- **å¼€æ”¾ç«¯å£**: 10911 [rocketMQé€šä¿¡ç”¨çš„]
- **æˆæƒç›®å½•**: 
```
chmod 777 /home/docker/rocketmq/broker/logs
chmod 777 /home/docker/rocketmq/broker/store
chmod 777 /home/docker/rocketmq/namesrv/logs
chmod 777 /home/docker/rocketmq/namesrv/store
```
- **å¯¼å…¥æ•°æ®åº“**: luohuo_im_01ã€luohuo_dev
- **æ‰§è¡Œå‘½ä»¤**: /bin/bash /home/jenkins/work/workspace/luohuo-cloud/src/main/bin/all-start.sh

![img_3.png](image/img_12.png)


- **æ³¨æ„äº‹é¡¹**: æ¶ˆæ¯æ¨é€é‡‡ç”¨CLUSTERINGæ¨¡å¼ï¼Œå•ä¸ªmqåªèƒ½è¢«ä¸€ä¸ªcloudé¡¹ç›®è¿æ¥ï¼Œå¤šä¸ªcloudå¯èƒ½ä¼šå¯¼è‡´æ¶ˆæ¯æ¥æ”¶ä¸åˆ°; è‹¥éœ€è¦å¤šæ¬¡è¿æ¥å¿…é¡»dockerå†å¼€ä¸€ä¸ªrocketmqçš„testç‰ˆæœ¬å•ç‹¬è¿æ¥ï¼Œç›´æ¥copy[rocketmqtest](rocketmqtest)ç›®å½• docker-compose up -då³å¯


## ğŸ› ï¸ æœ¬åœ°è§†é¢‘è¯­éŸ³ç”µè¯
- **æµè§ˆå™¨è¾“å…¥åœ°å€**: chrome://flags/
- **æœç´¢å…³é”®å­—**: Insecure origins treated as secure
- **å¼€æ”¾ç«¯å£å’Œip**: http://192.168.1.37:6130,http://192.168.1.24:6130,http://192.168.1.26:6130

## ğŸ” ç«¯åˆ°ç«¯åŠ å¯†ï¼ˆE2EEï¼‰åŠŸèƒ½éƒ¨ç½²

### åŠŸèƒ½è¯´æ˜
- HuLa æ”¯æŒç«¯åˆ°ç«¯åŠ å¯†ï¼ˆE2EEï¼‰åŠŸèƒ½ï¼Œä¿æŠ¤ç”¨æˆ·æ¶ˆæ¯éšç§
- åŠ å¯†æ–¹å¼ï¼šRSA-OAEP 2048 + AES-256-GCM
- æ ¸å¿ƒåŠŸèƒ½ï¼šå¯†é’¥ç®¡ç†ã€æ¶ˆæ¯åŠ å¯†/è§£å¯†ã€å¯†é’¥å¤‡ä»½æ¢å¤ã€å®‰å…¨å®¡è®¡

### æ•°æ®åº“åˆå§‹åŒ–
- E2EE ç›¸å…³è¡¨ä¼šåœ¨ IM æœåŠ¡å¯åŠ¨æ—¶è‡ªåŠ¨åˆ›å»ºï¼ˆMyBatis-Plus è‡ªåŠ¨å»ºè¡¨ï¼‰
- ä¸»è¦æ•°æ®è¡¨ï¼š
  - `e2ee_user_public_key` - ç”¨æˆ·å…¬é’¥
  - `e2ee_encrypted_message` - åŠ å¯†æ¶ˆæ¯
  - `e2ee_key_backup` - å¯†é’¥å¤‡ä»½
  - `e2ee_key_recovery_request` - å¯†é’¥æ¢å¤è¯·æ±‚
  - `e2ee_audit_log` - å®‰å…¨å®¡è®¡æ—¥å¿—

### Nacos é…ç½®
- åœ¨ Nacos é…ç½®ä¸­å¿ƒåˆ›å»º `application-e2ee.yml`
- é…ç½®ç¤ºä¾‹ï¼š

```yaml
e2ee:
  enabled: true
  key:
    rsa-key-size: 2048
    max-validity-days: 365
  cache:
    local-cache-size: 10000
    redis-cache-expire-hours: 24
  security:
    max-messages-per-minute: 60
    max-message-size: 10485760
  audit:
    retention-days: 90
```

- åœ¨ IM æœåŠ¡çš„ `bootstrap.yml` ä¸­å¼•å…¥é…ç½®ï¼š

```yaml
spring:
  cloud:
    nacos:
      config:
        shared-configs:
          - data-id: application-e2ee.yml
            refresh: true
```

### åŠŸèƒ½éªŒè¯
- è®¿é—®å¥åº·æ£€æŸ¥ï¼š`GET http://localhost:18760/e2ee/health`
- æŸ¥çœ‹ç›‘æ§æŒ‡æ ‡ï¼š`GET http://localhost:18760/actuator/prometheus`
- å…³é”®æŒ‡æ ‡ï¼š
  - `e2ee_active_users` - æ´»è·ƒE2EEç”¨æˆ·æ•°
  - `e2ee_messages_encrypted_total` - åŠ å¯†æ¶ˆæ¯æ€»æ•°
  - `e2ee_encryption_duration_seconds` - åŠ å¯†æ“ä½œå»¶è¿Ÿ

### ç°åº¦å‘å¸ƒæ§åˆ¶
- é€šè¿‡ Redis åŠ¨æ€æ§åˆ¶ï¼ˆæ— éœ€é‡å¯ï¼‰ï¼š
  - å…¨å±€å¼€å…³ï¼š`redis-cli SET e2ee:feature:global_enabled true`
  - ç°åº¦æ¯”ä¾‹ï¼š`redis-cli SET e2ee:feature:rollout_percentage 50`ï¼ˆ50% ç”¨æˆ·å¯ç”¨ï¼‰
  - æ·»åŠ ç™½åå•ï¼š`redis-cli SET e2ee:feature:whitelist:ç”¨æˆ·ID 1`

### å®šæ—¶ä»»åŠ¡
ç³»ç»Ÿå·²é…ç½®ä»¥ä¸‹è‡ªåŠ¨ä»»åŠ¡ï¼š
- æ¯å¤© 3:00 æ¸…ç†è¿‡æœŸå¯†é’¥
- æ¯å¤© 4:00 æ¸…ç†è¿‡æœŸæ¶ˆæ¯
- æ¯å¤© 5:00 æ¸…ç†è¿‡æœŸå®¡è®¡æ—¥å¿—
- æ¯å°æ—¶æ£€æŸ¥å¯†é’¥è½®æ¢
- æ¯15åˆ†é’Ÿæ”¶é›†ç»Ÿè®¡æ•°æ®

### ç›‘æ§å‘Šè­¦ï¼ˆå¯é€‰ï¼‰
- é…ç½® Prometheus æŠ“å– E2EE æŒ‡æ ‡
- å¯¼å…¥ Grafana ä»ªè¡¨ç›˜æ¨¡æ¿ï¼ˆ`docs/grafana/E2EE_Dashboard.json`ï¼‰
- é…ç½®å‘Šè­¦è§„åˆ™ï¼šé«˜å»¶è¿Ÿã€é«˜é”™è¯¯ç‡ç­‰

---

## ğŸ”§ è¿ç»´è„šæœ¬

### å¥åº·æ£€æŸ¥
```bash
# æ£€æŸ¥æ‰€æœ‰æœåŠ¡çŠ¶æ€
bash docker/health-check.sh
```

### æ•°æ®å¤‡ä»½
```bash
# æ‰‹åŠ¨å¤‡ä»½
bash docker/backup.sh

# æ·»åŠ å®šæ—¶å¤‡ä»½ (æ¯å¤©å‡Œæ™¨2ç‚¹)
crontab -e
# æ·»åŠ : 0 2 * * * /home/docker/backup.sh
```

### æœåŠ¡ç®¡ç†
```bash
# å¯åŠ¨æ‰€æœ‰æœåŠ¡
docker compose up -d

# åœæ­¢æ‰€æœ‰æœåŠ¡
docker compose down

# æŸ¥çœ‹æ—¥å¿—
docker compose logs -f [æœåŠ¡å]

# é‡å¯å•ä¸ªæœåŠ¡
docker compose restart [æœåŠ¡å]
```

---

## ğŸ“Š ç«¯å£æ¸…å•

| æœåŠ¡ | ç«¯å£ | è¯´æ˜ |
|------|------|------|
| MySQL | 13306 | æ•°æ®åº“ |
| Redis | 16379 | ç¼“å­˜ |
| Nacos | 8848 | é…ç½®ä¸­å¿ƒ |
| RocketMQ NameSrv | 9876 | æ¶ˆæ¯é˜Ÿåˆ— |
| RocketMQ Broker | 10909, 10911 | æ¶ˆæ¯é˜Ÿåˆ— |
| MinIO | 9000, 9001 | å¯¹è±¡å­˜å‚¨ |
| Jenkins | 20000 | CI/CD |
| Gateway | 18760 | APIç½‘å…³ |
| OAuth | 18761 | è®¤è¯æœåŠ¡ |
| IM | 18762 | IMæœåŠ¡ |
| WebSocket | 9501 | WebSocket |

---

## âš ï¸ å¸¸è§é—®é¢˜

### Q: RocketMQå¯åŠ¨å¤±è´¥
A: æ£€æŸ¥ `broker.conf` ä¸­çš„ `brokerIP1` æ˜¯å¦æ­£ç¡®é…ç½®

### Q: Nacoså¯åŠ¨å¤±è´¥
A: ç¡®ä¿å·²å¯¼å…¥ `mysql-schema.sql`

### Q: ç¼–è¯‘å¤±è´¥
A: ç¡®ä¿å…ˆç¼–è¯‘ `luohuo-util`ï¼Œå†ç¼–è¯‘ `luohuo-cloud`

### Q: æœåŠ¡æ— æ³•è¿æ¥æ•°æ®åº“
A: æ£€æŸ¥MySQL SSLè¯ä¹¦é…ç½®å’Œè¿æ¥å‚æ•°
